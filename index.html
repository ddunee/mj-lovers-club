<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‡¼ğŸ‡ªğŸ‡±ğŸ‡¨ğŸ‡´ğŸ‡²ğŸ‡ª ğŸ‡¹ğŸ‡´ ğŸ‡¹ğŸ‡­ğŸ‡ª ğŸ‡³ğŸ‡ªğŸ‡¼ ğŸ‡¦ğŸ‡©ğŸ‡»ğŸ‡ªğŸ‡³ğŸ‡¹ğŸ‡ºğŸ‡·ğŸ‡ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* í°íŠ¸ ì ìš© */
@font-face {
    font-family: 'RoundedFixedsys';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff');
    font-weight: normal;
    font-display: swap;
}

        body {
            font-family: 'DosSammul', sans-serif;
            background-color: #FFF0E6;
            background-image: 
                radial-gradient(#FFA880 15%, transparent 16%),
                radial-gradient(#FFA880 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            cursor: crosshair;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #FFF5F0; border-left: 2px solid #FFA880; }
        ::-webkit-scrollbar-thumb { background: #FFA880; border: 2px solid #FFF5F0; }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes wiggle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-wiggle { animation: wiggle 2s ease-in-out infinite; }
        .animate-blink { animation: blink 1s step-end infinite; }
        
        .retro-shadow { box-shadow: 4px 4px 0px rgba(255, 168, 128, 0.6); }
        .retro-shadow-hard { box-shadow: 4px 4px 0px #000; }

        .dashed-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='15' ry='15' stroke='%23FFA880FF' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            border-radius: 15px;
        }

        .sticker { position: absolute; z-index: 20; pointer-events: none; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.1)); }
        
        .page-section { display: none; animation: fadeIn 0.5s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-btn.active { background-color: #FFA880; color: white; transform: scale(1.05); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #FFA880; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex justify-center items-center p-4 sm:p-8">

    <div class="w-full max-w-5xl bg-white border-4 border-[#FFA880] rounded-3xl retro-shadow-hard relative overflow-hidden flex flex-col md:flex-row h-[85vh] md:h-[85vh]">
        
        <!-- ìŠ¤í‹°ì»¤ ì¥ì‹ -->
        <div class="sticker bottom-10 right-10 text-5xl animate-float" style="animation-delay: 1s;">ğŸ§¡</div>
        
        <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
        <div class="w-full md:w-1/3 bg-[#FFF5F0] border-b-4 md:border-b-0 md:border-r-4 border-[#FFA880] p-6 flex flex-col gap-6 overflow-y-auto shrink-0">
            
            <!-- í”„ë¡œí•„ -->
            <div class="bg-white border-2 border-dashed border-[#FFA880] rounded-2xl p-4 text-center relative retro-shadow">
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-[#FFA880] text-white px-3 py-1 rounded-full text-sm border-2 border-white">í›„ ì•„ ìœ </div>
                
                <!-- ë¡œê·¸ì¸ ì „ -->
                <div id="login-area" class="mt-8 mb-4">
                    <div class="w-24 h-24 mx-auto bg-gray-100 rounded-full flex items-center justify-center text-3xl mb-4">ğŸ·</div>
                    <p class="text-gray-500 text-sm mb-2">ë¡œê·¸ì¸ì´ í•„ìš”í•´ìš”!</p>
                    <button onclick="googleLogin()" class="bg-[#4285F4] text-white py-2 px-4 rounded-xl text-sm hover:bg-[#357ae8] transition flex items-center justify-center gap-2 mx-auto w-full">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545,10.545v4.364h6.218c-0.818,2.727-3.545,4.364-6.218,4.364c-3.6,0-6.545-2.945-6.545-6.545s2.945-6.545,6.545-6.545c1.418,0,2.727,0.545,3.818,1.455l3.273-3.273C17.564,2.345,15.164,1.273,12.545,1.273C6.655,1.273,1.818,6.109,1.818,12c0,5.891,4.836,10.727,10.727,10.727c5.345,0,9.455-3.927,9.455-9.455c0-0.873-0.073-1.527-0.218-2.182H12.545z"/></svg>
                        ë¡œê·¸ì¸
                    </button>
                </div>

                <!-- ë¡œê·¸ì¸ í›„ -->
                <div id="profile-area" class="hidden">
                    <div class="w-32 h-32 mx-auto bg-[#FFE4D6] rounded-full border-4 border-white shadow-lg overflow-hidden mb-4 mt-4 relative group">
                        <img id="user-photo" src="" class="w-full h-full object-cover hidden">
                        <div id="user-emoji" class="w-full h-full flex items-center justify-center text-6xl">ğŸ°</div>
                    </div>
                    <h2 id="user-name" class="text-2xl font-bold text-[#FF8A5C] mb-1">ëšœë‹ˆ</h2>
                    
                    <!-- ID í‘œì‹œ ì˜ì—­ -->
                    <div class="mb-4 text-left bg-gray-50 p-2 rounded border border-gray-200">
                        <p class="text-[10px] text-gray-400 mb-1">ID</p>
                        <div class="flex gap-1">
                            <input type="text" id="user-id-val" readonly class="w-full text-[10px] border rounded p-1 bg-white text-gray-600 font-mono focus:outline-none" value="...">
                            <button onclick="copyMyId()" class="bg-[#FFA880] text-white text-[10px] px-2 rounded hover:bg-[#FF8A5C] whitespace-nowrap">Copy</button>
                        </div>
                    </div>

                    <button onclick="googleLogout()" class="text-xs text-gray-400 underline hover:text-[#FFA880]">ë¡œê·¸ì•„ì›ƒ</button>
                </div>

                <div class="mt-4 bg-[#FFA880] text-white py-2 px-4 rounded-xl text-lg cursor-pointer hover:bg-[#FF8A5C]">ì¼ì´Œ ì‹ ì²­ â™¡</div>
            </div>

            <!-- ë©”ë‰´ ë„¤ë¹„ê²Œì´ì…˜ -->
            <nav class="flex flex-col gap-2">
                <button onclick="switchPage('home')" id="nav-home" class="nav-btn active bg-white border-2 border-[#FFA880] text-[#FFA880] p-3 rounded-xl text-left hover:bg-[#FFD4B8] transition-all flex items-center gap-2">
                    â–· HOME
                </button>
                <button onclick="switchPage('diary')" id="nav-diary" class="nav-btn bg-white border-2 border-[#FFA880] text-[#FFA880] p-3 rounded-xl text-left hover:bg-[#FFD4B8] transition-all flex items-center gap-2">
                    â–· DIARY
                </button>
                <button onclick="switchPage('photo')" id="nav-photo" class="nav-btn bg-white border-2 border-[#FFA880] text-[#FFA880] p-3 rounded-xl text-left hover:bg-[#FFD4B8] transition-all flex items-center gap-2">
                    â–· PHOTO
                </button>
                <button onclick="switchPage('guest')" id="nav-guest" class="nav-btn bg-white border-2 border-[#FFA880] text-[#FFA880] p-3 rounded-xl text-left hover:bg-[#FFD4B8] transition-all flex items-center gap-2">
                    â–· GUEST
                </button>
            </nav>
        </div>

        <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì½˜í…ì¸  -->
        <div class="w-full md:w-2/3 bg-white p-6 overflow-y-auto relative">
            
            <!-- í—¤ë” -->
            <div class="border-b-2 border-dashed border-[#FFA880] pb-4 mb-6 flex justify-between items-end sticky top-0 bg-white z-10">
                <div>
                    <h1 class="text-3xl md:text-4xl text-[#FFA880] mb-1 drop-shadow-sm">MJ LOVERS CLUB</h1>
                    <p class="text-gray-400 text-sm">ë‚´ì¼ì„ ê¸°ëŒ€í•˜ëŠ” ì˜¤ëŠ˜</p>
                </div>
                <div class="text-xs text-right hidden sm:block">
                    <p class="animate-blink text-[#FFA880]">ONLY ASTRO MJ</p>
                </div>
            </div>

            <!-- 1. HOME ì„¹ì…˜ -->
            <div id="page-home" class="page-section active">
                <div class="dashed-box min-h-[200px] p-4 mb-6 relative bg-[#FFF9F5] flex items-center justify-center overflow-hidden">
                    <div class="absolute top-2 left-2 bg-[#FFA880] text-white text-xs px-2 py-1 rounded">MINI ROOM</div>
                    <div class="text-6xl absolute bottom-4 left-10 animate-bounce"></div>
                    <div class="text-4xl absolute top-10 right-10 animate-wiggle text-[#FFA880]"></div>
                    <div class="text-5xl absolute bottom-10 right-20"></div>
                    <div class="text-center text-[#FFA880] opacity-60">
                        <p class="text-lg">Welcome to my Space!</p>
                        <p class="text-sm"></p>
                    </div>
                </div>
                <div class="bg-[#FFF5F0] p-4 rounded-xl border border-[#FFA880]">
                    <h3 class="text-lg text-[#FF8A5C] mb-2 font-bold">ğŸ“¢ Notice</h3>
                    <p class="text-sm text-gray-600">ë°©ëª…ë¡ì„ ì‘ì„±í•´ë³´ì„¸ìš”</p>
                </div>
            </div>

            <!-- 2. DIARY ì„¹ì…˜ -->
            <div id="page-diary" class="page-section">
                <div id="diary-write-area" class="bg-[#FFF9F5] p-4 rounded-xl border-2 border-dashed border-[#FFA880] mb-6 hidden">
                    <h3 class="text-[#FFA880] mb-2">ì˜¤ëŠ˜ì˜ ì¼ê¸°</h3>
                    <input type="text" id="diary-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full mb-2 p-2 border border-[#FFD4B8] rounded font-[DosSammul] focus:outline-none focus:border-[#FFA880]">
                    <textarea id="diary-content" placeholder="ì˜¤ëŠ˜ ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”?" class="w-full h-20 p-2 border border-[#FFD4B8] rounded font-[DosSammul] focus:outline-none focus:border-[#FFA880] resize-none"></textarea>
                    <div class="text-right mt-2">
                        <button onclick="addDiary()" class="bg-[#FFA880] text-white px-4 py-2 rounded hover:bg-[#FF8A5C] transition">ì €ì¥í•˜ê¸°</button>
                    </div>
                </div>
                <div id="diary-login-msg" class="text-center text-gray-400 py-4 text-sm">ğŸ”’ ë¡œê·¸ì¸ì„ í•˜ë©´ ì¼ê¸°ë¥¼ ì“¸ ìˆ˜ ìˆì–´ìš”.</div>
                <div id="diary-list" class="space-y-4">
                    <div class="loader"></div>
                </div>
            </div>

            <!-- 3. PHOTO ì„¹ì…˜ -->
            <div id="page-photo" class="page-section">
                <div id="photo-write-area" class="bg-[#FFF9F5] p-4 rounded-xl border-2 border-dashed border-[#FFA880] mb-6 hidden">
                    <h3 class="text-[#FFA880] mb-2">ğŸ“¸ ì‚¬ì§„ ì˜¬ë¦¬ê¸°</h3>
                    <div class="flex gap-2 items-center">
                        <input type="file" id="photo-input" accept="image/*" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#FFA880] file:text-white hover:file:bg-[#FF8A5C]">
                        <button onclick="uploadPhoto()" class="bg-[#FFA880] text-white px-4 py-2 rounded hover:bg-[#FF8A5C] transition whitespace-nowrap">ì—…ë¡œë“œ</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">* ë„ˆë¬´ í° ì‚¬ì§„ì€ ìë™ìœ¼ë¡œ ì‘ê²Œ ì¡°ì •ë¼ìš”!</p>
                </div>
                <div id="photo-login-msg" class="text-center text-gray-400 py-4 text-sm">ğŸ”’ ë¡œê·¸ì¸ì„ í•˜ë©´ ì‚¬ì§„ì„ ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”.</div>
                <div id="photo-list" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <div class="loader col-span-full"></div>
                </div>
            </div>

            <!-- 4. GUEST ì„¹ì…˜ -->
            <div id="page-guest" class="page-section">
                <div class="flex gap-2 mb-6 bg-[#FFF9F5] p-3 rounded-xl border border-[#FFA880]">
                    <input type="text" id="guest-name" placeholder="ì´ë¦„" class="border border-[#FFD4B8] rounded px-2 py-1 text-sm w-1/4 focus:outline-none font-[DosSammul]">
                    <input type="text" id="guest-msg" placeholder="ì¼ì´Œí‰ ë‚¨ê¸°ê¸°..." class="border border-[#FFD4B8] rounded px-2 py-1 text-sm flex-1 focus:outline-none font-[DosSammul]">
                    <button onclick="addGuestbook()" class="bg-[#FFA880] text-white px-3 py-1 rounded text-sm hover:bg-[#FF8A5C]">ë“±ë¡</button>
                </div>
                <div id="guest-list" class="space-y-2 h-[400px] overflow-y-auto pr-2">
                     <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKoL7t8QgoybDCPNvVDiWYX0X7EawW7oM",
            authDomain: "ddunee-d98c8.firebaseapp.com",
            projectId: "ddunee-d98c8",
            storageBucket: "ddunee-d98c8.firebasestorage.app",
            messagingSenderId: "811699710436",
            appId: "1:811699710436:web:7a5ff72d4c972dc95efff1",
            measurementId: "G-GQ5WDGFXTD"
        };

        const appId = "my-peach-diary";
        
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        // [ì—…ë°ì´íŠ¸ ì™„ë£Œ] ìŠ¤í¬ë¦°ìƒ·ì˜ IDë¥¼ ì ìš©í–ˆìŠµë‹ˆë‹¤!
        // ì´ì œ ì´ IDë¡œ ë¡œê·¸ì¸í•˜ë©´ 'ëŒ€ì¥'ìœ¼ë¡œ ì¸ì‹ë˜ì–´ ëª¨ë“  ê¸€ì„ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        const ADMIN_ID = "zT7TuSZWf0eKde0Ho53mqY4BlEJ3"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;

        function init() {
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                updateUI(user);
                subscribeDiary();
                subscribePhotos();
                subscribeGuestbook();
            });
        }
        init();

        window.googleLogin = async () => {
            try { await signInWithPopup(auth, provider); } 
            catch (error) { console.error(error); alert("ë¡œê·¸ì¸ ì‹¤íŒ¨! ë„ë©”ì¸ ìŠ¹ì¸ í™•ì¸ í•„ìš”."); }
        };

        window.googleLogout = () => {
            signOut(auth);
            alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

        window.copyMyId = () => {
            const idVal = document.getElementById('user-id-val');
            idVal.select();
            document.execCommand('copy');
            alert("ID ë³µì‚¬ ì™„ë£Œ! íŒŒì´ì–´ë² ì´ìŠ¤ ê·œì¹™ ìˆ˜ì •ì— ì‚¬ìš©í•˜ì„¸ìš”.");
        }

        function updateUI(user) {
            const loginArea = document.getElementById('login-area');
            const profileArea = document.getElementById('profile-area');
            const diaryWrite = document.getElementById('diary-write-area');
            const diaryMsg = document.getElementById('diary-login-msg');
            const photoWrite = document.getElementById('photo-write-area');
            const photoMsg = document.getElementById('photo-login-msg');

            if (user) {
                loginArea.classList.add('hidden');
                profileArea.classList.remove('hidden');
                document.getElementById('user-name').innerText = user.displayName || "ì´ë¦„ ì—†ìŒ";
                document.getElementById('user-id-val').value = user.uid;
                if(user.photoURL) {
                    document.getElementById('user-photo').src = user.photoURL;
                    document.getElementById('user-photo').classList.remove('hidden');
                    document.getElementById('user-emoji').classList.add('hidden');
                }
                diaryWrite.classList.remove('hidden');
                diaryMsg.classList.add('hidden');
                photoWrite.classList.remove('hidden');
                photoMsg.classList.add('hidden');
            } else {
                loginArea.classList.remove('hidden');
                profileArea.classList.add('hidden');
                diaryWrite.classList.add('hidden');
                diaryMsg.classList.remove('hidden');
                photoWrite.classList.add('hidden');
                photoMsg.classList.remove('hidden');
            }
        }

        window.addDiary = async () => {
            if (!currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•´ìš”!');
            const title = document.getElementById('diary-title').value;
            const content = document.getElementById('diary-content').value;
            if (!title || !content) return alert('ì…ë ¥í•´ì£¼ì„¸ìš”!');
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'diary'), {
                    authorId: currentUser.uid,
                    title: title,
                    content: content,
                    createdAt: serverTimestamp()
                });
                document.getElementById('diary-title').value = '';
                document.getElementById('diary-content').value = '';
                alert('ì €ì¥ ì™„ë£Œ! ğŸ“’');
            } catch (e) { alert('ì €ì¥ ì‹¤íŒ¨ ã… ã…  (íŒŒì´ì–´ë² ì´ìŠ¤ ê·œì¹™ í™•ì¸ í•„ìš”)'); }
        };

        function subscribeDiary() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'diary'));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('diary-list');
                list.innerHTML = '';
                const docs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                docs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                if (docs.length === 0) list.innerHTML = '<p class="text-center text-gray-400 py-10">ì¼ê¸°ê°€ ì—†ì–´ìš”.</p>';

                docs.forEach(data => {
                    const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'ë°©ê¸ˆ ì „';
                    // ë‚´ê°€ ì“´ ê¸€ì´ê±°ë‚˜, ë‚´ê°€ ëŒ€ì¥(ADMIN_ID)ê³¼ ê°™ìœ¼ë©´ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
                    const isAuthor = currentUser && data.authorId === currentUser.uid;
                    const isAdmin = currentUser && currentUser.uid === ADMIN_ID;
                    
                    const deleteBtn = (isAuthor || isAdmin) ? 
                        `<button onclick="deleteItem('diary', '${data.id}')" class="absolute top-2 right-2 text-xs text-red-300 hover:text-red-500 transition">ì‚­ì œ</button>` : '';

                    const el = document.createElement('div');
                    el.className = 'bg-[#FFF5F0] rounded-xl p-4 border border-[#FFA880] relative group';
                    el.innerHTML = `<div class="flex justify-between items-center border-b border-white pb-2 mb-2"><h4 class="font-bold text-[#FF8A5C]">${data.title}</h4><span class="text-xs text-gray-400">${date}</span></div><p class="text-gray-600 text-sm whitespace-pre-wrap">${data.content}</p>${deleteBtn}`;
                    list.appendChild(el);
                });
            });
        }

        window.uploadPhoto = async () => {
            if (!currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•´ìš”!');
            const fileInput = document.getElementById('photo-input');
            if (!fileInput.files[0]) return alert('ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = async function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 400; const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth; canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const base64String = canvas.toDataURL('image/jpeg', 0.7);
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'photos'), {
                            authorId: currentUser.uid,
                            image: base64String,
                            createdAt: serverTimestamp()
                        });
                        fileInput.value = ''; alert('ì—…ë¡œë“œ ì™„ë£Œ! ğŸ“¸');
                    } catch (e) { alert('ì‹¤íŒ¨ ã… ã… '); }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(fileInput.files[0]);
        };

        function subscribePhotos() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'photos'));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('photo-list');
                list.innerHTML = '';
                const docs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                docs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                if (docs.length === 0) list.innerHTML = '<p class="col-span-full text-center text-gray-400 py-10">ì‚¬ì§„ì´ ì—†ì–´ìš”.</p>';

                docs.forEach(data => {
                    const isAuthor = currentUser && data.authorId === currentUser.uid;
                    const isAdmin = currentUser && currentUser.uid === ADMIN_ID;
                    const deleteBtn = (isAuthor || isAdmin) ? 
                        `<button onclick="deleteItem('photos', '${data.id}')" class="absolute top-1 right-1 bg-white rounded-full p-1 text-xs text-red-400 shadow z-10">ğŸ—‘ï¸</button>` : '';
                    const el = document.createElement('div');
                    el.className = 'aspect-square bg-white p-1 rounded border border-[#FFA880] relative group';
                    el.innerHTML = `<img src="${data.image}" class="w-full h-full object-cover rounded">${deleteBtn}`;
                    list.appendChild(el);
                });
            });
        }

        window.addGuestbook = async () => {
            const name = document.getElementById('guest-name').value;
            const msg = document.getElementById('guest-msg').value;
            if (!name || !msg) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'guestbook'), {
                    authorId: currentUser ? currentUser.uid : 'anonymous',
                    name: name, message: msg, createdAt: serverTimestamp()
                });
                document.getElementById('guest-msg').value = '';
            } catch (e) { console.error(e); }
        };

        function subscribeGuestbook() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'guestbook'));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('guest-list');
                list.innerHTML = '';
                const docs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                docs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                docs.forEach(data => {
                    // ë°©ëª…ë¡: ë‚´ê°€ ì¼ê±°ë‚˜, ë‚´ê°€ ëŒ€ì¥ì´ë©´ ì‚­ì œ ê°€ëŠ¥
                    const isAuthor = currentUser && data.authorId === currentUser.uid;
                    const isAdmin = currentUser && currentUser.uid === ADMIN_ID;
                    const deleteBtn = (isAuthor || isAdmin) ? 
                        `<button onclick="deleteItem('guestbook', '${data.id}')" class="text-gray-300 hover:text-red-400">x</button>` : '';
                    const el = document.createElement('div');
                    el.className = 'bg-[#FFF9F5] p-2 rounded border border-dashed border-[#FFD4B8] text-sm flex justify-between group';
                    el.innerHTML = `<span><span class="text-[#FFA880] font-bold">${data.name}:</span> ${data.message}</span>${deleteBtn}`;
                    list.appendChild(el);
                });
            });
        }

        window.deleteItem = async (collectionName, docId) => {
            if (!currentUser || !confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, docId)); } 
            catch(e) { alert('ì‚­ì œ ì‹¤íŒ¨ (ê¶Œí•œì´ ì—†ì–´ìš”)'); }
        };

        window.switchPage = function(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.getElementById(`nav-${pageId}`).classList.add('active');
        };
    </script>
</body>
</html>
